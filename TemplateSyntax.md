# Версия 1

Используется в настоящее время и заточена под гибкость конфигурирования для любых видов заявок, договоров и т.п.

Большинство имён и идентификаторов не зависят от регистра и переводятся во время обработки в нижний регистр
(для совместимости с синтаксисом функций XPath).

## Доступные идентификаторы (и выражения)

Имена, раскрывающиеся в значения этих полей.
Определяются интерактором верхнего уровня.
Например, обработчик заявки подготавливает поля для самой заявки.
В этом случае, в отличие от предыдущей версии -
интерактор парсера только занимается обработкой формата вставки
и перекладывает часть своих задач на внешний объект,
обрабатывающий, к примеру, формат ролей доступа.

Идентификаторы представлляют собой простые поля или контейнеры с объектами.
Внутренняя вложенность неограничена, а циклическая - исключена.

Для хранения данных используется структурный язык `XML`,
а для доступа к полям - его язык запросов `XPath 1.0`.

### Доступ к простому полю

Выражается простой строкой, его именем.

Схема:
```xml
<document template="file.docx">
	<year>2022</year>
</document>
```
Запрос:
`year`,
`Year`  (содержaт `2022`).

### Доступ к контейнеру

Выражается в точности как к простому полю, однако сам по себе применяется только для описания таблицы.

Схема:
```xml
<document template="file.docx">
	<listitem>Mixed siblings item 1</listitem>
	<listitem>Mixed siblings item 2</listitem>
	<listitem>Mixed siblings item n</listitem>
	<list>
		<item>Single type item 1</item>
		<item>Single type item 2</item>
		<item>Single type item n</item>
	</list>
</document>
```
Запрос:
`listitem` (содержит объекты `listitem`),
`list/*` (содержит объекты `item`).

### Доступ к содержимому контейнеров

У контейнера есть содержимое - некоторое количество объектов.
Эти объекты содержат такие же идентификаторы, как и внешний уровень.
Такая структура допускает глубокую иерархию данных.

Элементы могут находиться по порядку, а могут составлять словарь с численным ключом.

Схема:
```xml
<document template="file.docx">
	<element key="1">Mixed siblings item 1</element>
	<element key="2">Mixed siblings item 2</element>
	<element key="n">Mixed siblings item n</element>
	<list>
		<element>Single type item 1</element>
		<element>Single type item 2</element>
		<element>Single type item n</element>
	</list>
</document>
```
Запрос:
`element[@key=1]` (содержит объект `Mixed siblings item 1`),
`element[@key="n"]` (содержит объект `Mixed siblings item n`),
`list/element[3]` (содержит объект `Single type item n`).

#### В таблице

Контейнер легко развернуть в таблицу, используя доступ к контейнеру.
Внутри таблицы обращение уже пойдёт к полям такого объекта (смена контекста).

Например, если таблица содержит перечисление сотрудников,
элемент управления для целой строки помечается идентификатором контейнера:
`employee`.

Внутри этой строки уже будут использоваться поля объекта сотрудника, например:
`#` (Служебное поле порядкового номера (или числового идентификатора) элемента, начиная с единицы),
`name`,
`mobile_phone`.

Схема:
```xml
<document template="file.docx">
	<tableline key="1">
		<name>alpha</name>
		<quantity>1.2</quantity>
	</tableline>
	<tableline key="2">
		<name>betta</name>
		<quantity>2.34</quantity>
	</tableline>
	<tableline key="n">
		<name>gamma</name>
		<quantity>5</quantity>
	</tableline>
</document>
```
Запрос (строки > поля в строке):
`tableline` > `name` (содержит `alpha`,`betta`,`gamma`),
`tableline` > `count(preceding-sibling::tableline)+number(1)` (содержит `1`,`2`,`3`).

#### Вне (и внутри) таблицы

Вне таблицы используется специальный синтаксис сначала для доступа к отдельным элементам контейнера,
а затем и для доступа к полям содержимых объектов.

Пример доступа к элементам:
`employee[@key=0]`,
`role[2]`.

Пример доступа к полям объекта:
`role[@key=135]/name`,
`claim[@key=11352]/id`.

## Этап разбора

Этап разбора никак не отличается от предыдущей версии.

## Этап наполнения

Этапом наполнения руководят парсер и источник полей документа.

### Парсер

#### Логическое поле

- Больше НЕ допускает ведущие символы "!", инвертирующие значение поля.
- Допускает поля со значенинями "True" или "False" (независимо от регистра).

#### Текстовое поле

Работает в точнности как текстовое поле на этапе выполнения предыдущей версии синтаксиса.

# Версия 0

Не используется в настоящее время и заточена под задачу о заявках.

## Доступные идентификаторы

То есть имена, раскрывающиеся в значения этих полей.

### Идентификатор поля заявки

Целое число.
Пример:
`1018`.

### Идентификатор дополнительного поля

Строка любого регистра.
Пример:
`year`.

### Идентификатор роли доступа

Строка, начинающаяся на звёздочку (`*`) и оканчивающаяся на символ типа доступа:
- Запрошен (allowed) = `a`
- Изменён (changed) = `c`
- Отозван (denied) = `d`
Между этими символами прописывается числовой идентификатор роли, в противном случае расчёт идёт по всему ресурсу.
Примеры:
`*a`,
`*c`,
`*1352a`,
`*846d`.

## Этап разбора

Из документа выбираются элементы управления содержимым верхнего уровня (без вложенных в "таблицы").
Затем рекурсивно определяются все поля документа, включая содержимое таблиц.
Для таблиц имеется особый вид "вставки", не подразумевающий встраивание иных таблиц.
Следовательно максимальный уровень "рекурсии" - единица.

У элемента управления содержимым определяется его тип: для текстового поля - текстовая вставка, для флажка - логическая,
а для элемента без типа (по умолчанию - форматированный текст) - вставка формы (таблицы).

## Этап наполнения

### Логическое поле

- Допускает неограниченное количество ведущих символов "!", инвертирующих значение поля.
- Допускает поля заявки или пользовательские поля со значенинями "True" или "False" (независимо от регистра).
- Допускает значение установки ролей доступа к ресурсу.

Простой пример:
`20` (При условии, что поле запроса содержит значение `true` или `false`).

Сложный пример:
`!*230d`

### Текстовое поле

- Допускает неограниченное перечисление идентификаторов полей заявки
- Допускает любое значение

При перечислении полей доступны разделители `,` и `/`, замешаемые в `, ` и ` / ` соответственно.
Сложный пример:
`name,201/year,address`

### Форматированное поле

- Имеет одно только использование для заполнения заявки с зарегестрированным идентификатором КРР-04 ИС ОДФР
- Имеет пять "столбцов": порядковый номер ресурса (строка), его имя (строка), первая-третья роли (логические поля)
