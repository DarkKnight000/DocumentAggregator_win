# Манифест приложения

Document aggregator - Проект глобального Web-API приложения для автоматизации документооборота.

Автор:
Костин Анатолий (anatoly.kostin.work@gmail.com)

Редактирование:
Бадалов Ашот (ashot.badalov@gmail.com)

Требования:
- Доступ из существующей инфраструктуры\
	Данный проект должен быть легко интегрируем в существующую систему создания и обработки заявок. Для этого выбран тип проекта Web-API с фреймворком ASP.NET.
- Расширяемость\
	Так как проект новый, перспективный и экспериментальный, используется итеративная модель разработки, позволяющая начинать с малых задач и далее наращивать функционал.\
	Кроме того, архитектурой для данного проекта выбрана "[Clean Architecture](https://fullstackmark.com/post/18/building-aspnet-core-web-apis-with-clean-architecture)", благодаря которой ослабляются связи между классами, улучшается тестируемость и расширяемость кода.

---
В названиях классов в проекте чаще всего "заявка" как `request` заменено словом `claim` для избежания путаницы с "запросом заявки".

## Корпоративный уровень - Сущности

### Бизнес-объекты

Модели проекта:

- Claim - Заявка
- FormInsert - Вставка иерархическая
- Insert - Вставка

### Случаи использования

Обработка заявки

- ClaimRequest - Запрос на заявку
- ClaimResponse - Ответ от генератора
- ClaimInteractor - Класс обработки заявки

Обработка документа

- FormRequest - Запрос на докуомент
- FormResponse - Ответ от редактора
- FormInteractor - Класс обработки формы

Обработка вставки

- InsertRequest - Запрос на вставку
- InsertResponse - Ответ от парсера
- ParseInsertInteractor - Класс обработки вставки

### Интерфейсы

Внедрение зависимостей

- ILogger - Собственный интерфейс журналирования
- IOptions - Интерфейс для доступа к параметрам конфигурации
- ILoggerFactory & IOptionsFactory - Позволяют привязывать экземпляры журнала и конфигурации к реализуемым типам

Внешние службы

- IClaimRepository - Репозиторий объектов `Claim`
- IEditorService - Сервис редактора документа

## Уровень приложения - Случай использования
|||
|-|-|
|Заголовок|Сборщик документов|
|Описание|Сервер базы данных обращается по запросу к программе с набором аргументов, достаточных для генерации отчётности. Затем считывает сгенерированный документ на выходе.|
|Основное действующее лицо|Сервер базы данных|
|Предварительные условия|<ul><li>Заявка создана</li><li>Обязательные поля заявки заполнены</li></ul>|
|Последовательные условия|Создан отчёт по конкретной заявке|
|Основной успешный сценарий|<ol><li>Сервер посылает HTTP запрос с данными о заявке.</li><li>Система проверяет и дополняет данные из базы данных.</li><li>Система сопоставляет поля заявки с полученными данными и заполняет шаблон.</li><li>Система возвращает поток с содержимым файла или ссылку на файл.</li></ol>|
|Расширения|<ul><li>(2a) Нет доступных данных по заявке.</li><ol><li>Система возвращает ответ с кодом, текстом ошибки и дополнительными данными.</li></ol><li>(3a) Найдено поле с отсутствующим значением.</li><ol><li>Система возвращает ответ с кодом, текстом ошибки и дополнительными данными.</li></ol></ul>|

Сответствие полей:
|Поле заявки (значение)|Поле шаблона (упоминание)|Результат|
|-|-|-|
|отсутствует|отсутствует|Корректно.|
|отсутствует|присутствует|Генерация продолжается, но поле документа остаётся пустым.<br/>Выдаётся предупреждение.|
|присутствует|отсутствует|Корректно.<br/>*Возможна запись в локальный лог.*|
|присутствует|присутствует|Корректно.|

## Уровень адаптеров интерфейсов

### OracleDatabase

Предоставляет доступ к базе данных.

### EditorService

Управляет жизненным циклом документа и его конвертацией.

## Уровень программного интерфейса приложения

### Ошибка уровня ASP .NET Core

Содержит код ошибки и следующий заголовок:
```
Content-Type: application/problem+json; charset=utf-8
```

Содержимое пакета зависит от ошибки.

# Причины отказа от решений в ходе разработки

## OfficeInterop

Первым и самым простым способом работы с файлами DOCX был взят OfficeInterop.
Но благодаря проблемам серверной автоматизации, а именно полного отсутствия её варианта реализации, от данной библиотеки отказались, а модуль `DocAggregator.API.Infrastructure.OfficeInterop` заброшен.

Справка: [Вопросы серверной автоматизации Office](https://support.microsoft.com/ru-ru/topic/%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%BD%D0%BE%D0%B9-%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-office-48bcfe93-8a89-47f1-0bce-017433ad79e2)

## Редактирование файла .DOCX на лету, в памяти

Одним из моих желаний, как разработчика, был контроль за объектами.
Файлу нет смысла быть записаным на диск, если программа, породившая его, через секунду его уже уничтожит...
Подумал я и реализовал редактирование архива в рамках потока `MemoryStream`.
Но, вопреки ожиданиям, изменения ни за что не желали сохраняться в память.
Проблема оказалась далеко не в классе `WordprocessingDocument`, который и позволяет использовать любой вид потока на вход.
Ошибка находится в самом .NET Core, который не даёт сохранить данные потока до его закрытия.
Закрытие файлового потока работает, данные остаются на диске.
Закрытие потока в памяти приводит к полной потере данных.

- Трекер ошибки из репозитория OpenXML SDK: [Calling Save() doesn't flush to the stream · Issue #294 · OfficeDev/Open-XML-SDK · GitHub](https://github.com/OfficeDev/Open-XML-SDK/issues/294)
- Трекер ошибки из репозитория .NET: [Add Flush to ZipArchive · Issue #24149 · dotnet/runtime · GitHub](https://github.com/dotnet/runtime/issues/24149)

На .NET Framework такой ошибки нет.

Это могло бы подсказать ответ: [c# - Open XML WordprocessingDocument with MemoryStream is 0KB - Stack Overflow](https://stackoverflow.com/questions/61196148/open-xml-wordprocessingdocument-with-memorystream-is-0kb)

## Запись лога в базу данных

Отложено, так как запись в медленное хранилище данных требует дополнительных управляющих обектов.

Справка: [Guidance on how to log to a message queue for slow data stores · Issue #11801 · dotnet/AspNetCore.Docs · GitHub](https://github.com/dotnet/AspNetCore.Docs/issues/11801)

# Другие беды

## unoconvert: connection refused

```
NoConnectException: Connector : couldn't connect to socket (WSAECONNREFUSED, Connection refused)
```

Вероятно, сервер не отвечает, потому что не запущен.

## unoconvert: type detection failed

```
IllegalArgumentException: Unsupported URL <file:///C:/bla/bla.docx>: "type detection failed"
```

Не выяснено, по какой причине возникает. Решалось перезагрузкой конвертера?
